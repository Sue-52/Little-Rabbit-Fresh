## 首页模块

### 1. 顶部通栏布局

思路：

- [x] 引用字体图标库, 顶部通栏中的图标都是字体图标
- [x] 创建顶部通栏组件 `AppTopNav`, 实现基础布局
- [x] 根据登录状态切换显示用户名和登录按钮

------

第一步：在 `public/index.html` 引入字体图标

~~~html
<link rel="stylesheet" href="//at.alicdn.com/t/font_2143783_iq6z4ey5vu.css">
~~~

第二步：书写`components/AppTopNav.vue`布局样式

~~~vue
<template>
  <nav class="app-top-nav">
    <div class="container">
      <ul>
        <li>
          <a href="javascript:"><i class="iconfont icon-user"></i>周杰伦</a>
        </li>
        <li><a href="javascript:">退出登录</a></li>
        <li><a href="javascript:">请先登录</a></li>
        <li><a href="javascript:">免费注册</a></li>
        <li><a href="javascript:">我的订单</a></li>
        <li><a href="javascript:">会员中心</a></li>
        <li><a href="javascript:">帮助中心</a></li>
        <li><a href="javascript:">关于我们</a></li>
        <li>
          <a href="javascript:"><i class="iconfont icon-phone"></i>手机版</a>
        </li>
      </ul>
    </div>
  </nav>
</template>

<script>
export default {
  name: "AppTopNav",
};
</script>

<style scoped lang="less">
.app-top-nav {
  background: #333;
  ul {
    display: flex;
    height: 53px;
    justify-content: flex-end;
    align-items: center;
    li {
      a {
        padding: 0 15px;
        color: #cdcdcd;
        line-height: 1;
        display: inline-block;
        i {
          font-size: 14px;
          margin-right: 2px;
        }
        &:hover {
          color: @xtxColor;
        }
      }
      ~ li {
        a {
          border-left: 2px solid #666;
        }
      }
    }
  }
}
</style>
~~~

第三步：根据当前登录状态切换显示用户名和退出登录

~~~vue
<template>
<!-- 判断用户是否登录，判断是否携带了Token -->
<template v-if="user.profile.token">
  <li>
    <a href="javascript:"
      ><i class="iconfont icon-user"></i>{{ user.profile.accont }}</a
    >
  </li>
  <li><a href="javascript:">退出登录</a></li>
</template>
<template v-else>
  <li><a href="javascript:">请先登录</a></li>
  <li><a href="javascript:">免费注册</a></li>
</template>
</template>

<script>
import { useStore } from "vuex";

export default {
  name: "AppTopNav",
  setup() {
    const store = useStore();
    const user = store.state.user;
    return {
      user,
    };
  },
};
</script>
~~~

### 2. 头部布局

在`component/AppHeader.vue` 书写布局样式

~~~vue
<template>
  <header class="app-header">
    <div class="container">
      <h1 class="logo"><RouterLink to="/"></RouterLink></h1>
      <ul class="app-header-nav">
        <li class="home">
          <RouterLink to="/">首页</RouterLink>
        </li>
        <li><a href="#">美食</a></li>
        <li><a href="#">餐厨</a></li>
        <li><a href="#">艺术</a></li>
        <li><a href="#">电器</a></li>
        <li><a href="#">居家</a></li>
        <li><a href="#">洗护</a></li>
        <li><a href="#">孕婴</a></li>
        <li><a href="#">服装</a></li>
        <li><a href="#">杂货</a></li>
      </ul>
      <div class="search">
        <i class="iconfont icon-search"></i>
        <input type="text" placeholder="搜一搜" />
      </div>
      <div class="cart">
        <a class="curr" href="#">
          <i class="iconfont icon-cart"></i><em>2</em>
        </a>
      </div>
    </div>
  </header>
</template>

<script>
export default {
  name: "AppHeader",
};
</script>

<style scoped lang="less">
.app-header {
  background: #fff;
  .container {
    display: flex;
    align-items: center;
  }
  .logo {
    width: 200px;
    a {
      display: block;
      height: 132px;
      width: 100%;
      text-indent: -9999px;
      background: url(../assets/images/logo.png) no-repeat center 18px / contain;
    }
  }
  .app-header-nav {
    width: 820px;
    display: flex;
    justify-content: space-around;
    padding-left: 40px;
    position: relative;
    z-index: 998;

    > li {
      margin-right: 40px;
      width: 38px;
      text-align: center;

      > a {
        font-size: 16px;
        line-height: 32px;
        height: 32px;
        display: inline-block;
      }

      &:hover {
        > a {
          color: @xtxColor;
          border-bottom: 1px solid @xtxColor;
        }

        > .layer {
          height: 132px;
          opacity: 1;
        }
      }
    }
  }
  .search {
    width: 170px;
    height: 32px;
    position: relative;
    border-bottom: 1px solid #e7e7e7;
    line-height: 32px;
    .icon-search {
      font-size: 18px;
      margin-left: 5px;
    }
    input {
      width: 140px;
      padding-left: 5px;
      color: #666;
    }
  }
  .cart {
    width: 50px;
    .curr {
      height: 32px;
      line-height: 32px;
      text-align: center;
      position: relative;
      display: block;
      .icon-cart {
        font-size: 22px;
      }
      em {
        font-style: normal;
        position: absolute;
        right: 0;
        top: 0;
        padding: 1px 6px;
        line-height: 1;
        background: @helpColor;
        color: #fff;
        font-size: 12px;
        border-radius: 10px;
        font-family: Arail, serif;
      }
    }
  }
}
</style>
~~~

### 3. 底部布局

在 `component/AppFooter.vue` 书写布局样式

~~~vue
<template>
  <footer class="app-footer">
    <!-- 联系我们 -->
    <div class="contact">
      <div class="container">
        <dl>
          <dt>客户服务</dt>
          <dd><i class="iconfont icon-kefu"></i> 在线客服</dd>
          <dd><i class="iconfont icon-question"></i> 问题反馈</dd>
        </dl>
        <dl>
          <dt>关注我们</dt>
          <dd><i class="iconfont icon-weixin"></i> 公众号</dd>
          <dd><i class="iconfont icon-weibo"></i> 微博</dd>
        </dl>
        <dl>
          <dt>下载APP</dt>
          <dd class="qrcode">
            <img src="../assets/images/qrcode.jpg" alt="" />
          </dd>
          <dd class="download">
            <span>扫描二维码</span>
            <span>立马下载APP</span>
            <a href="javascript:">下载页面</a>
          </dd>
        </dl>
        <dl>
          <dt>服务热线</dt>
          <dd class="hotline">
            400-0000-000 <small>周一至周日 8:00-18:00</small>
          </dd>
        </dl>
      </div>
    </div>
    <!-- 其它 -->
    <div class="extra">
      <div class="container">
        <div class="slogan">
          <a href="javascript:">
            <i class="iconfont icon-footer01"></i>
            <span>价格亲民</span>
          </a>
          <a href="javascript:">
            <i class="iconfont icon-footer02"></i>
            <span>物流快捷</span>
          </a>
          <a href="javascript:">
            <i class="iconfont icon-footer03"></i>
            <span>品质新鲜</span>
          </a>
        </div>
        <!-- 版权信息 -->
        <div class="copyright">
          <p>
            <a href="javascript:">关于我们</a>
            <a href="javascript:">帮助中心</a>
            <a href="javascript:">售后服务</a>
            <a href="javascript:">配送与验收</a>
            <a href="javascript:">商务合作</a>
            <a href="javascript:">搜索推荐</a>
            <a href="javascript:">友情链接</a>
          </p>
          <p>CopyRight © 小兔鲜儿</p>
        </div>
      </div>
    </div>
  </footer>
</template>

<script>
export default {
  name: "AppFooter",
};
</script>

<style scoped lang="less">
.app-footer {
  overflow: hidden;
  background-color: #f5f5f5;
  padding-top: 20px;
  .contact {
    background: #fff;
    .container {
      padding: 60px 0 40px 25px;
      display: flex;
    }
    dl {
      height: 190px;
      text-align: center;
      padding: 0 72px;
      border-right: 1px solid #f2f2f2;
      color: #999;
      &:first-child {
        padding-left: 0;
      }
      &:last-child {
        border-right: none;
        padding-right: 0;
      }
    }
    dt {
      line-height: 1;
      font-size: 18px;
    }
    dd {
      margin: 36px 12px 0 0;
      float: left;
      width: 92px;
      height: 92px;
      padding-top: 10px;
      border: 1px solid #ededed;
      .iconfont {
        font-size: 36px;
        display: block;
        color: #666;
      }
      &:hover {
        .iconfont {
          color: @xtxColor;
        }
      }
      &:last-child {
        margin-right: 0;
      }
    }
    .qrcode {
      width: 92px;
      height: 92px;
      padding: 7px;
      border: 1px solid #ededed;
    }
    .download {
      padding-top: 5px;
      font-size: 14px;
      width: auto;
      height: auto;
      border: none;
      span {
        display: block;
      }
      a {
        display: block;
        line-height: 1;
        padding: 10px 25px;
        margin-top: 5px;
        color: #fff;
        border-radius: 2px;
        background-color: @xtxColor;
      }
    }
    .hotline {
      padding-top: 20px;
      font-size: 22px;
      color: #666;
      width: auto;
      height: auto;
      border: none;
      small {
        display: block;
        font-size: 15px;
        color: #999;
      }
    }
  }
  .extra {
    background-color: #333;
  }
  .slogan {
    height: 178px;
    line-height: 58px;
    padding: 60px 100px;
    border-bottom: 1px solid #434343;
    display: flex;
    justify-content: space-between;
    a {
      height: 58px;
      line-height: 58px;
      color: #fff;
      font-size: 28px;
      i {
        font-size: 50px;
        vertical-align: middle;
        margin-right: 10px;
        font-weight: 100;
      }
      span {
        vertical-align: middle;
        text-shadow: 0 0 1px #333;
      }
    }
  }
  .copyright {
    height: 170px;
    padding-top: 40px;
    text-align: center;
    color: #999;
    font-size: 15px;
    p {
      line-height: 1;
      margin-bottom: 20px;
    }
    a {
      color: #999;
      line-height: 1;
      padding: 0 10px;
      border-right: 1px solid #999;
      &:last-child {
        border-right: none;
      }
    }
  }
}
</style>
~~~

### 4. 抽取导航栏布局

思路：

- [x] 新建导航组件 `AppHeaderNav`, 拷贝组件所需结构和样式
- [x] 完成导航下拉菜单基础布局

------

第一步：将导航栏内容抽取出来，放到 `components/AppHeaderNav.vue` 组件中

~~~vue
<template>
  <ul class="app-header-nav">
    <li class="home">
      <RouterLink to="/">首页</RouterLink>
    </li>
    <li><a href="#">美食</a></li>
    <li><a href="#">餐厨</a></li>
    <li><a href="#">艺术</a></li>
    <li><a href="#">电器</a></li>
    <li><a href="#">居家</a></li>
    <li><a href="#">洗护</a></li>
    <li><a href="#">孕婴</a></li>
    <li><a href="#">服装</a></li>
    <li><a href="#">杂货</a></li>
  </ul>
</template>

<script>
export default {
  name: "AppHeaderNav",
};
</script>

<style scoped lang="less">
.app-header-nav {
  width: 820px;
  display: flex;
  justify-content: space-around;
  padding-left: 40px;
  position: relative;
  z-index: 998;

  > li {
    margin-right: 40px;
    width: 38px;
    text-align: center;

    > a {
      font-size: 16px;
      line-height: 32px;
      height: 32px;
      display: inline-block;
    }

    &:hover {
      > a {
        color: @xtxColor;
        border-bottom: 1px solid @xtxColor;
      }

      > .layer {
        height: 132px;
        opacity: 1;
      }
    }
  }
}
</style>
~~~

第二步：一级分类下的二级分类布局（与一级分类中的a标签同级）

~~~html
<div class="layer">
  <ul>
    <li v-for="i in 10" :key="i">
      <a href="#">
        <img src="http://zhoushugang.gitee.io/erabbit-client-pc-static/uploads/img/category%20(4).png" alt=""/>
        <p>果干</p>
      </a>
    </li>
  </ul>
</div>
~~~

样式

~~~vue
<style lang="less">
  .layer {
    width: 1240px;
    background-color: #fff;
    position: absolute;
    left: -200px;
    top: 56px;
    height: 0;
    overflow: hidden;
    opacity: 0;
    box-shadow: 0 0 5px #ccc;
    transition: all .2s .1s;
    ul {
      display: flex;
      flex-wrap: wrap;
      padding: 0 70px;
      align-items: center;
      height: 132px;
      li {
        width: 110px;
        text-align: center;
        img {
          width: 60px;
          height: 60px;
        }
        p {
          padding-top: 10px;
        }
        &:hover {
          p {
            color: @xtxColor;
          }
        }
      }
    }
  }
</style>
~~~

### 5. 导航栏数据填充

思路：

- [x] 创建用于向服务器端发送请求获取分类列表数据的 API 接口函数
- [x] 在 Vuex 中创建用于获取分类数据的 `action` 方法, 创建用于设置本地分类列表状态的 `mutation` 方法
- [x] 在 `AppLayout` 组件中触发 vuex 中的用于获取分类列表数据的 `action` 方法
- [x] 在 `AppHeaderNav` 组件中获取 vuex 中的分类列表数据并填充至模板
- [x] 准备一级分类静态数据并将其设置为 vuex 中分类列表数据的默认值

------

第一步：在 `src/api/category.js` 中创建获取分类列表数据的 API 接口函数

[首页-全部分类(包含推荐商品)](http://zhoushugang.gitee.io/erabbit-client-pc-document/api.html#u9996u9875-u5168u90e8u5206u7c7buff08u5305u542bu63a8u8350u5546u54c1uff090a3ca20id3du9996u9875-u5168u90e8u5206u7c7buff08u5305u542bu63a8u8350u5546u54c1uff093e203ca3e)

~~~js
import request from "@/utils/request";

/**
 * @typedef {object} Category - 分类对象
 * @property {string} id - 分类id
 * @property {string} name - 分类名称
 * @property {string} picture - 分类封面图片
 * @property {Category} children - 子级分类对象
 * @property {RecommendGoods} goods - 该分类下的推荐商品
 */

/**
 * @typedef {object} RecommendGoods 推荐商品
 * @property {string} id - 商品id
 * @property {string} name 商品名称
 * @property {string} desc 商品描述
 * @property {null | number} discount - 折扣信息
 * @property {number} orderNum - 销量
 * @property {string} picture - 商品图片
 * @property {string} price - 商品价格
 */

/**
 * 获取分类列表
 * @return {Promise<{result: Array<Category>}>}
 */
export function getCategoriesApi() {
  return request("/home/category/head", "get");
}
~~~

第二步：在 `src/store/category.js` 的`action`处调用 `getCategoriesApi` 方法，异步调用。

~~~js
import { getCategoriesApi } from "@/api/category";

export default {
  mutations: {
    /**
     * 设置分类列表数据
     * @param state
     * @param {Array<Category>} categories - 分类列表
     */
    setCategories(state, categories) {
      state.list = categories;
    },
  },
  actions: {
    /**
     * 向服务器端发送请求获取分类列表数据
     * @param commit
     * @return {Promise<void>}
     */
    async getCategories({ commit }) {
      // 发送请求获取数据
      const { result } = await getCategoriesApi();
      // 将数据存储在 vuex 中
      commit("setCategories", result);
    },
  },
}
~~~

第三步：在`LayoutTemplate`组件获取分类，因为有两处调用该方法，将其分开写会发送两次请求。

~~~js
import { useStore } from 'vuex'

export default {
  setup () {
    // 获取 store 对象
    const store = useStore()
    // 发送请求获取分类数据
    store.dispatch("category/getCategories");
  }
}
~~~

第四步：在`AppHeaderNav`组件中获取分类数据并填充至模板。

~~~js
import { useStore } from "vuex";

export default {
  name: "AppHeaderNav",
  setup() {
    // 获取 store 对象
    const store = useStore();
    // 获取分类模块状态
    const category = store.state.category;
    // 返回组件所需状态
    return { category };
  },
};
~~~

~~~html
<ul class="app-header-nav">
  <li class="home">
    <router-link to="/">首页</router-link>
  </li>
  <li v-for="item in category.list" :key="item.id">
    <a href="#">{{ item.name }}</a>
    <div class="layer">
      <ul>
        <li v-for="sub in item.children" :key="sub.id">
          <a href="#">
            <img :src="sub.picture" :alt="sub.name" />
            <p>{{ sub.name }}</p>
          </a>
        </li>
      </ul>
    </div>
  </li>
</ul>
~~~

第五步：因为异步请求需要时间的响应，所以当页面在加载时，我们只能看到导航栏出只有一个首页二字，这样的用户体验并不好，所以为了就解决这个问题，我们可以将导航栏数据设为静态资源，并将其传给Vuex。因为导航栏数据一般情况变化并不会很大。所以，做成静态并没有太大问题。

`api/category.js`

~~~js
// 一级分类
export const topCategories = [
  "居家",
  "美食",
  "服饰",
  "母婴",
  "个护",
  "严选",
  "数码",
  "运动",
  "杂货",
];
~~~

`store/category.js`

~~~js
import { topCategories } from "@/api/category";

export default {
  // 使用具有命名空间的 vuex 模块
  namespaced: true,
  state() {
    return {
      // 存储分类列表
      list: topCategories.map((item) => ({
        name: item,
      })),
    };
  }
}
~~~

### 6. 创建分类路由

思路：

- [x] 创建一级分类、二级分类页面组件
- [x] 配置一级分类路由及二级分类路由对应的路由规则
- [x] 在导航 `AppHeaderNav` 组件中添加路由跳转链接

------

首先，我们需要创建一级分类、二级分类页面组件。

`views/category/TopCategory.vue`

~~~vue
<template>
  <LayoutTemplate>
    <div>TopCategoryPage</div>
  </LayoutTemplate>
</template>

<script>
import LayoutTemplate from "@/views/LayoutTemplate.vue";
export default {
  components: { LayoutTemplate },
};
</script>

<style></style>
~~~

`views/category/SubCategory.vue`

~~~vue
<template>
  <LayoutTemplate>
    <div>SubCategoryPage</div>
  </LayoutTemplate>
</template>

<script>
import LayoutTemplate from "@/views/LayoutTemplate.vue";
export default {
  components: { LayoutTemplate },
};
</script>

<style></style>
~~~

第二步：在路由文件中配置该路由

`router/index.js`

~~~js
const TopCategoryPage = () =>
  import(
    /*webpackChunkName: 'TopCategoryPage'*/ "@/views/category/TopCategoryPage"
  );
const SubCategoryPage = () =>
  import(
    /*webpackChunkName: 'webpackChunkName'*/ "@/views/category/SubCategoryPage"
  );

const routes = [
  {
    path: "/category/:id",
    component: TopCategoryPage,
  },
  {
    path: "/category/sub/:id",
    component: SubCategoryPage,
  },
];
~~~

第三步：在`components/AppHeaderNav.vue`添加路由链接

~~~html
<!-- 一级路由链接 -->
<router-link :to="`/category/${item.id}`">{{ item.name }}</router-link>
<!-- 二级路由链接 -->
<router-link :to="`/category/sub/${sub.id}`"> ... </router-link>
~~~

### 7. 控制导航栏的下拉菜单显示和隐藏

思路：

- [x] 去除控制导航下拉菜单显示隐藏的 hover 样式代码
- [x] 编写 open 类名, 通过 JS 为元素添加或删除open类名来控制元素的显示和隐藏
- [x] 在 vuex 中为每一个一级分类数据添加 open 布尔值状态以控制是否显示导航下拉菜单
- [x] 在 vuex 中创建用于控制导航下拉菜单显示隐藏的方法 (修改布尔值数据)
- [x] 在组件中根据 open 布尔值状态为下拉菜单动态绑定控制其显示和隐藏的类名
- [x] 在组件中为元素添加事件最终实现导航下拉菜单的显示和隐藏

------

第一步：去除控制导航下拉菜单显示隐藏的 `hover` 样式代码

~~~less
.app-header-nav {
  > li {
    // 去除以下代码
    &:hover {
      > .layer {
        height: 132px;
        opacity: 1;
      }
    }
  }
}
~~~

第二步：在 `.layer` 下添加一个 `open` 类名用来控制显示和隐藏

~~~less
.layer {
  &.open {
   height: 132px;
   opacity: 1;
  }
}
~~~

第三步：在 `store/category.js` 下添加一个 `open` 布尔值状态以控制导航下拉菜单显示隐藏

~~~js
actions: {
    async getCategories({ commit }) {
      const { result } = await getCategoriesApi();
      result.forEach((element) => {
        element.open = false;
      });
      commit("setCategories", result);
    },
  },
~~~

第四步：在 `store/category.js` 中添加`open`和`close`方法用来控制 open 的布尔值状态。

~~~js
  mutations: {
    open(state, id) {
      const item = state.list.find((item) => item.id === id);
      item.open = true;
    },
    close(state, id) {
      const item = state.list.find((item) => item.id === id);
      item.open = false;
    },
  },
~~~

第五步：判断用户行为，在`mouseenter、mouseleave、click`的时候添加事件，并给 `.layer` 绑定open类

~~~vue
<template>
  <ul class="app-header-nav">
    <li class="home">
      <router-link to="/">首页</router-link>
    </li>
    <li
      @mouseenter="open(item.id)"
      @mouseleave="close(item.id)"
      @click="close(item.id)"
      v-for="item in category.list"
      :key="item.id"
    >
      <div class="layer" :class="{ open: item.open }"> ... </div>
    </li>
  </ul>
</template>

<script>
import { useStore } from "vuex";

export default {
  name: "AppHeaderNav",
  setup() {
    const open = (id) => {
      store.commit("category/open", id);
    };
    const close = (id) => {
      store.commit("category/close", id);
    };
    return {
      open,
      close,
    };
  },
};
</script>
~~~

### 8. 实现吸顶导航（手写实现）

思路：

- [x] 创建吸顶导航组件 `AppHeaderSticky`, 完成基础布局
- [x] 在 `AppLayout` 组件中调用吸顶导航组件
- [x] 为吸顶导航组件添加样式, 让它在默认情况下隐藏
- [x] 封装一个通用的获取滚动距离的方法 `useScrollTop`
- [x] 在组件中调用 `useScrollTop` 方法获取滚动距离, 根据滚动距离控制吸顶导航的显示和隐藏

------

第一步：创建吸顶导航栏布局`components/AppHeaderSticky.vue`

~~~vue
<template>
  <div class="app-header-sticky">
    <div class="container">
      <RouterLink to="/" class="logo" />
      <AppHeaderNav />
      <div class="right">
        <RouterLink to="/">品牌</RouterLink>
        <RouterLink to="/">专题</RouterLink>
      </div>
    </div>
  </div>
</template>

<script>
import AppHeaderNav from "@/components/AppHeaderNav";
export default {
  name: "AppHeaderSticky",
  components: { AppHeaderNav },
};
</script>

<style scoped lang="less">
.app-header-sticky {
  width: 100%;
  height: 80px;
  position: fixed;
  left: 0;
  top: 0;
  z-index: 999;
  background-color: #fff;
  border-bottom: 1px solid #e4e4e4;
  .container {
    display: flex;
    align-items: center;
  }
  .logo {
    width: 200px;
    height: 80px;
    background: url(../assets/images/logo.png) no-repeat right 2px;
    background-size: 160px auto;
  }
  .right {
    width: 220px;
    display: flex;
    text-align: center;
    padding-left: 40px;
    border-left: 2px solid @xtxColor;
    a {
      width: 38px;
      margin-right: 40px;
      font-size: 16px;
      line-height: 1;
      &:hover {
        color: @xtxColor;
      }
    }
  }
}
</style>
~~~

第二步：放入`views/LayoutTemplate.vue`

~~~vue
<template>
  <AppHeader />
  <AppHeaderSticky />
</template>
<script>
import AppHeaderSticky from "@/components/AppHeaderSticky";
export default {
  components: { AppHeaderSticky },
}
</script>
~~~

第三步：给吸顶导航过渡动画

~~~css
.app-header-sticky {
  transition: translateY(-100%);
  opacity: 0;
}
~~~

第四步：获取window自带的scroll滚动事件，并将其封装为：`hooks/useScrollTop.js`

~~~js
import { ref, onMounted, onUnmounted } from "vue";

// TODO: useScrollTop
export default function useScrollTop() {
  // 存储滚动条的位置
  const scrollTop = ref(0);
  // 滚动事件处理函数
  const onScrollHandler = () => {
    scrollTop.value =
      document.documentElement.scrollTop || document.body.scrollTop;
  };
  // 组件初始化时，绑定滚动事件
  onMounted(() => {
    // 绑定滚动事件
    window.addEventListener("scroll", onScrollHandler);
  });
  // 组件销毁时，解绑滚动事件
  onUnmounted(() => {
    // 解绑滚动事件
    window.removeEventListener("scroll", onScrollHandler);
  });

  // 返回滚动条的位置
  return scrollTop;
}
~~~

第五步：在 `AppHeaderSticky.vue` 中调用该方法

~~~vue
<script>
import AppHeaderNav from "@/components/AppHeaderNav";
// 引入封装的滚动事件
import useScrollTop from "@/hooks/useScrollTop";
export default {
  name: "AppHeaderSticky",
  components: { AppHeaderNav },
  setup() {
    return { scrollTop: useScrollTop() };
  },
};
</script>
~~~

第六步：判断在什么高度的时候显示吸顶导航栏

~~~html
  <div class="app-header-sticky" :class="{ show: scrollTop > 78 }"> ... </div>
~~~

第七步：问题：当我们实现后会发现，当鼠标放入一级分类后显示出了二级分类，但是我们把鼠标往上移动，会发现二级分类并未消失。这是因为吸顶导航栏的样式`transition: translateY(-100%);opacity: 0;`只是让其往上移动了，并且覆盖了上面的内容，所以我们需要进行判断，当滚动到一定的高度时，在让其显示，没有则隐藏;使用`v-show`

~~~html
<div class="container" v-show="scrollTop > 78"> ... </div>
~~~

### 9. 实现吸顶导航（工具库实现）

思路：

- [x] 使用工具库提供的 `useWindowScroll` 方法获取页面滚动距离

------

第一步：安装`npm install @vueuse/core@6.1.0`

~~~powershell
npm install @vueuse/core@6.1.0
~~~

第二步：直接在对应的文件中调用 `useWindowScroll` 

~~~vue
<template>
  <div class="app-header-sticky" :class="{ show: scrollTop > 78 }">
    <div class="container" v-show="scrollTop > 78">
      <RouterLink to="/" class="logo" />
      <AppHeaderNav />
      <div class="right">
        <RouterLink to="/">品牌</RouterLink>
        <RouterLink to="/">专题</RouterLink>
      </div>
    </div>
  </div>
</template>

<script>
import AppHeaderNav from "@/components/AppHeaderNav";
// 工具库实现滚动事件
import { useWindowScroll } from "@vueuse/core";
export default {
  name: "AppHeaderSticky",
  components: { AppHeaderNav },
  setup() {
    const { y: scrollTop } = useWindowScroll();
    return { scrollTop };
  },
};
</script>
~~~

### 10. 左侧分类结构渲染

思路：

- [x] 创建首页左侧分类列表组件, 实现基础布局
- [x] 在首页页面组件中调用左侧分类列表组件
- [x] 根据分类列表数据计算出新的左侧分类列表组件所需要的数据
- [x] 渲染新的分类列表数据至模板
- [x] 将计算左侧分类列表的逻辑抽取成单独的方法

------

第一步：创建 `src/views/home/components/HomeCategory.vue`，并实现布局页面

~~~vue
<template>
  <div class="home-category">
    <ul class="menu">
      <li v-for="i in 10" :key="i">
        <RouterLink to="/">居家</RouterLink>
        <RouterLink to="/">洗漱</RouterLink>
        <RouterLink to="/">清洁</RouterLink>
      </li>
    </ul>
  </div>
</template>

<script>
export default {
  name: "HomeCategory",
};
</script>
<style scoped lang="less">
.home-category {
  width: 250px;
  height: 500px;
  background: rgba(0, 0, 0, 0.8);
  position: relative;
  z-index: 99;
  .menu {
    li {
      padding-left: 40px;
      height: 50px;
      line-height: 50px;
      &:hover {
        background-color: @xtxColor;
      }
      a {
        margin-right: 4px;
        color: #fff;
        &:first-child {
          font-size: 16px;
        }
      }
    }
  }
}
</style>
~~~

第二步：引入到`HomePage.vue`

~~~vue
<template>
  <LayoutTemplate>
    <div class="container">
      <HomeCategory />
    </div>
  </LayoutTemplate>
</template>

<script>
import LayoutTemplate from "@/views/LayoutTemplate.vue";
import HomeCategory from "@/views/home/components/HomeCategory.vue";
export default {
  components: {
    LayoutTemplate,
    HomeCategory,
  },
  name: "HomePage",
};
</script>
~~~

第三步：获取`store/category` 中的 list 数据，并且根据要求，我们需要的children数量为2，需要进行条件判断截取 2 条数据

~~~js
<script>
import { computed, ref } from "@vue/reactivity";
import { useStore } from "vuex";

export default {
  name: "HomeCategory",
  setup() {
    const store = useStore();
    // 分类数据
    const category = computed(() => {
      // 获取分类数据,并便利
      const list = store.state.category.list.map((item) => ({
        ...item,
        // 分类下的子分类，我们只需要2个数据
        children: item.children ? item.children.slice(0, 2) : [],
      }));
      // 返回 list
      return list;
    });
    return {
      category,
    };
  },
};
</script>
~~~

第四步：进行模板渲染，并且书写路由链接

~~~html
<ul class="menu">
  <li v-for="item in category" :key="item.id">
    <router-link :to="`/category/${item.id}`">{{ item.name }}</router-link>
    <router-link
      v-for="sub in item.children"
      :key="sub.id"
      :to="`/category/sub/${sub.id}`"
      >{{ sub.name }}</router-link
    >
  </li>
</ul>
~~~

第五步：我们会发现，底部和设计表中少了一条数据，所以我们需要添加一条品牌的数据

~~~js
// 品牌数据
const brand = ref({
  name: "品牌",
  id: "brand",
  children: [{ name: "品牌推荐", id: "brand-recommend" }],
  brands: [],
});
// 分类数据
const category = computed(() => {
  ...
  // 将品牌数据插入到分类数据
  list.push(brand.value);
  return list;
});
~~~

第六步：将其抽取为单独的逻辑

~~~js
/** 将左侧列表抽取成单独的逻辑
 * returns {Array}
 */
function useMenuList() {
  const store = useStore();
  // 品牌数据
  const brand = ref({
    name: "品牌",
    id: "brand",
    children: [{ name: "品牌推荐", id: "brand-recommend" }],
    brands: [],
  });
  // 分类数据
  const category = computed(() => {
    // 获取分类数据,并便利
    const list = store.state.category.list.map((item) => ({
      ...item,
      // 分类下的子分类，我们只需要2个数据
      children: item.children ? item.children.slice(0, 2) : [],
    }));
    // 将品牌数据插入到分类数据
    list.push(brand.value);
    // 返回 list
    return list;
  });

  return category;
}
~~~

第七步：调用该方法

~~~js
setup() {
    return {
      menuList: useMenuList(),
    };
  },
~~~

### 11. 实现左侧分类列表商品推荐

- [ ] 在 `HomeCategory` 组件中添加弹层基础结构和样式
- [ ] 当鼠标移入分类列表时记录当前移入的分类
- [ ] 根据当前移入的分类渲染对应的推荐商品至模板

------

第一步：在 `HomeCategory` 组件中添加弹层基础结构和样式

~~~html
<!-- 注意: 此弹层结构放在 ul.menu 下面 -->
<div class="layer">
  <h4>分类商品推荐 <small>根据您的购买或浏览记录推荐</small></h4>
  <ul>
    <li v-for="i in 9" :key="i">
      <RouterLink to="/">
        <img src="https://yanxuan-item.nosdn.127.net/5a115da8f2f6489d8c71925de69fe7b8.png"alt=""/>
        <div class="info">
          <p class="name ellipsis-2">【定金购】严选零食大礼包（12件）</p>
          <p class="desc ellipsis">超值组合装，满足馋嘴欲</p>
          <p class="price"><i>¥</i>100.00</p>
        </div>
      </RouterLink>
    </li>
  </ul>
</div>
~~~

~~~css
// 注意: 此弹层样式放置在 .home-category 内部
.layer {
  width: 990px;
  height: 500px;
  background: rgba(255, 255, 255, 0.8);
  position: absolute;
  left: 250px;
  top: 0;
  display: none;
  padding: 0 15px;
  h4 {
    font-size: 20px;
    font-weight: normal;
    line-height: 80px;
    small {
      font-size: 16px;
      color: #666;
    }
  }
  ul {
    display: flex;
    flex-wrap: wrap;
    li {
      width: 310px;
      height: 120px;
      margin-right: 15px;
      margin-bottom: 15px;
      border: 1px solid #eee;
      border-radius: 4px;
      background: #fff;
      &:nth-child(3n) {
        margin-right: 0;
      }
      a {
        display: flex;
        width: 100%;
        height: 100%;
        align-items: center;
        padding: 10px;
        &:hover {
          background: #e3f9f4;
        }
        img {
          width: 95px;
          height: 95px;
        }
        .info {
          padding-left: 10px;
          line-height: 24px;
          width: 190px;
          .name {
            font-size: 16px;
            color: #666;
          }
          .desc {
            color: #999;
          }
          .price {
            font-size: 22px;
            color: @priceColor;
            i {
              font-size: 16px;
            }
          }
        }
      }
    }
  }
}
&:hover {
  .layer {
    display: block;
  }
}
~~~

第二步：当鼠标移入一级分类将数据保存并渲染模板

~~~vue
<template>
<li :class="{ active: current?.id && current.id === item.id }"></li>
</template>
<script>
  setup(){
    const current = ref();
    return {
      current,
    }
  }
</script>
~~~

~~~html
<div class="layer" v-if="current">
  <h4>分类商品推荐 <small>根据您的购买或浏览记录推荐</small></h4>
  <ul v-if="current.goods">
    <li v-for="item in current.goods" :key="item.id">
      <RouterLink to="/">
        <img :src="item.picture" :alt="item.name" />
        <div class="info">
          <p class="name ellipsis-2">{{ item.name }}</p>
          <p class="desc ellipsis">{{ item.desc }}</p>
          <p class="price"><i>¥</i>{{ item.price }}</p>
        </div>
      </RouterLink>
    </li>
  </ul>
</div>
~~~

### 12. 实现左侧品牌列表

- [ ] 在 `HomeCategory` 组件中添加品牌推荐的基础布局
- [ ] 创建用于获取品牌推荐数据的API接口函数
- [ ] 获取品牌推荐数据并渲染至模板
- [ ] 实现移入分类的选中效果

------

第一步：基础布局

~~~html
<!-- 注意: 此布局放置在 .layer 中, 放置在商品推荐 ul 的后面 -->
<ul>
  <li class="brand" v-for="i in 6" :key="i">
    <RouterLink to="/">
      <img src="http://zhoushugang.gitee.io/erabbit-client-pc-static/uploads/brand_goods_1.jpg" alt="">
      <div class="info">
        <p class="place"><i class="iconfont icon-dingwei"></i>北京</p>
        <p class="name ellipsis">DW</p>
        <p class="desc ellipsis-2">DW品牌闪购</p>
      </div>
    </RouterLink>
  </li>
</ul>
~~~

~~~css
// 注意: 此样式方式在 .layer/ul 中
li.brand {
  height: 180px;
  a {
    align-items: flex-start;
    img {
      width: 120px;
      height: 160px;
    }
    .info {
      p {
        margin-top: 8px;
      }
      .place {
        color: #999;
      }
    }
  }
}
~~~

第二步：创建品牌API接口

~~~js
/**
 * 获取热门品牌
 * @param {number} limit - 请求多少条数据
 * @return {Promise<{result: Array<Brand>}>}
 */
export function getHotBrand(limit = 6) {
  return requestWithoutToken("/home/brand", "get", { limit });
}
~~~

测试是否获取到了数据

~~~js
  getBrand().then((res) => {
    brand.value.brands = res;
  });
~~~

第三步：获取品牌推荐数据并渲染至模板

~~~html
<ul v-if="current && current.brands">
  <li class="brand" v-for="item in current.brands" :key="item.id">
    <RouterLink to="/">
      <img :src="item.logo" :alt="item.name" />
      <div class="info">
        <p class="place">
          <i class="iconfont icon-dingwei"></i>{{ item.place }}
        </p>
        <p class="name ellipsis">{{ item.nameEn }}</p>
        <p class="desc ellipsis-2">{{ item.name }}</p>
      </div>
    </RouterLink>
  </li>
</ul>
~~~

第四步：实现移入分类的选中效果

~~~html
<div class="home-category" @mouseleave="current = null">
    <ul class="menu">
      <!-- 如果鼠标移入的分类就是当前分类就为当前li添加 active 类名 -->
      <li :class="{ active: current && current.id === topCategory.id }"></li>
		<ul>
</div>
~~~

~~~css
.menu {
    li {
      &:hover, &.active {
        background-color: @xtxColor;
      }
    }
  }
~~~

### 13. 实现左侧分类骨架效果

- [ ] 创建骨架屏组件, 实现基础布局
- [ ] 将骨架屏组件通过 Vue 插件注册为全局可以使用的组件
- [ ] 使用骨架屏组件实现左侧二级分类菜单加载等待效果

------

第一步：创建骨架屏组件, 实现基础布局 `components/library/XtxSkeleton.vue`

~~~vue
<template>
  <div class="xtx-skeleton" :style="{ width, height }" :class="animated">
    <!-- 1 盒子-->
    <div class="block" :style="{ backgroundColor: bg }"></div>
    <!-- 2 闪效果 xtx-skeleton 伪元素 --->
  </div>
</template>
<script>
export default {
  name: "XtxSkeleton",
  // 使用的时候需要动态设置 高度，宽度，背景颜色，动画效果
  props: {
    bg: {
      type: String,
      default: "#efefef",
    },
    width: {
      type: String,
      default: "100px",
    },
    height: {
      type: String,
      default: "100px",
    },
    animated: {
      type: String,
      default: "scroll", // 'fade'
    },
  },
};
</script>
<style scoped lang="less">
.xtx-skeleton {
  display: inline-block;
  position: relative;
  overflow: hidden;
  vertical-align: middle;
  .block {
    width: 100%;
    height: 100%;
    border-radius: 2px;
  }
}
@keyframes scroll {
  0% {
    left: -100%;
  }
  100% {
    left: 120%;
  }
}
@keyframes fade {
  from {
    opacity: 0.2;
  }
  to {
    opacity: 1;
  }
}
.scroll {
  &::after {
    content: "";
    position: absolute;
    animation: scroll 1.5s ease 0s infinite;
    top: 0;
    width: 50%;
    height: 100%;
    background: linear-gradient(
      to left,
      rgba(255, 255, 255, 0) 0,
      rgba(255, 255, 255, 0.3) 50%,
      rgba(255, 255, 255, 0) 100%
    );
    transform: skewX(-45deg);
  }
}
.fade {
  animation: fade 1s linear infinite alternate;
}
</style>
~~~

第二步：将骨架屏组件通过 Vue 插件注册为全局可以使用的组件 `components/libaray/index.js`

~~~js
import XtxSkeleton from "@/components/library/XtxSkeleton";

export default {
  install(app) {
    app.component(XtxSkeleton.name, XtxSkeleton);
  },
};
~~~

`main.js` 全局配置

~~~js
import UI from "@/components/library";

createApp(App).use(store).use(router).use(UI).mount('#app')
~~~

第三步：使用骨架屏组件实现左侧二级分类菜单加载等待效果

~~~html
<li
  :class="{ active: current?.id && current.id === item.id }"
  v-for="item in menuList"
  @mouseenter="current = item"
  :key="item.id"
>
  <router-link :to="`/category/${item.id}`">{{ item.name }}</router-link>
  <template v-if="item.children.length">
    <router-link
      v-for="sub in item.children"
      :key="sub.id"
      :to="`/category/sub/${sub.id}`"
      >{{ sub.name }}</router-link
    >
  </template>
  <template v-else>
    <XtxSkeleton
      animated="fade"
      width="60px"
      height="18px"
      bg="rgba(255,255,255,0.2)"
      style="margin-right: 5px"
    ></XtxSkeleton>
    <XtxSkeleton
      animated="fade"
      width="60px"
      height="18px"
      bg="rgba(255,255,255,0.2)"
    ></XtxSkeleton>
  </template>
</li>
~~~

### 14. 实现轮播图布局

- [ ] 新建轮播图组件, 实现基础布局
- [ ] 将轮播图组件注册为应用级全局组件
- [ ] 创建 `HomeBanner` 组件，在该组件中调用轮播图组件, 用于限制轮播组件的大小及位置
- [ ] 在 `HomePage` 首页组件中调用 `HomeBanner` 组件, 实现静态轮播图结构展示

------

第一步：`components/libaray/XtxCarousel.vue` 轮播图布局

~~~vue
<template>
  <div class="xtx-carousel">
    <ul class="carousel-body">
      <li class="carousel-item fade">
        <RouterLink to="/">
          <img
            src="http://yjy-xiaotuxian-dev.oss-cn-beijing.aliyuncs.com/picture/2021-04-15/1ba86bcc-ae71-42a3-bc3e-37b662f7f07e.jpg"
            alt=""
          />
        </RouterLink>
      </li>
    </ul>
    <a href="javascript:" class="carousel-btn prev"
      ><i class="iconfont icon-angle-left"></i
    ></a>
    <a href="javascript:" class="carousel-btn next"
      ><i class="iconfont icon-angle-right"></i
    ></a>
    <div class="carousel-indicator">
      <span v-for="i in 5" :key="i"></span>
    </div>
  </div>
</template>

<script>
export default {
  name: "XtxCarousel",
};
</script>
<style scoped lang="less">
.xtx-carousel {
  width: 100%;
  height: 100%;
  min-width: 300px;
  min-height: 150px;
  position: relative;
  .carousel {
    &-body {
      width: 100%;
      height: 100%;
    }
    &-item {
      width: 100%;
      height: 100%;
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      transition: opacity 0.5s linear;
      &.fade {
        opacity: 1;
        z-index: 1;
      }
      img {
        width: 100%;
        height: 100%;
      }
    }
    &-indicator {
      position: absolute;
      left: 0;
      bottom: 20px;
      z-index: 2;
      width: 100%;
      text-align: center;
      span {
        display: inline-block;
        width: 12px;
        height: 12px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 50%;
        cursor: pointer;
        ~ span {
          margin-left: 12px;
        }
        &.active {
          background: #fff;
        }
      }
    }
    &-btn {
      width: 44px;
      height: 44px;
      background: rgba(0, 0, 0, 0.2);
      color: #fff;
      border-radius: 50%;
      position: absolute;
      top: 228px;
      z-index: 2;
      text-align: center;
      line-height: 44px;
      opacity: 0;
      transition: all 0.5s;
      &.prev {
        left: 20px;
      }
      &.next {
        right: 20px;
      }
    }
  }
  &:hover {
    .carousel-btn {
      opacity: 1;
    }
  }
}
</style>
~~~

第二步：注册为全局组件

~~~js
import XtxCarousel from "@/components/library/XtxCarousel";

export default {
  install(app) {
    app.component(XtxCarousel.name, XtxCarousel);
  },
};
~~~

第三步：`views/home/components/HomeBanner.vue` 在首页创建对应轮播图

~~~vue
<template>
  <div class="home-banner">
    <XtxCarousel />
  </div>
</template>
<script>
export default {
  name: "HomeBanner",
};
</script>
<style scoped lang="less">
.home-banner {
  width: 1240px;
  height: 500px;
  position: absolute;
  left: 0;
  top: 0;
  z-index: 98;
  .xtx-carousel {
    :deep(.carousel-btn.prev) {
      left: 270px;
    }
    :deep(.carousel-indicator) {
      padding-left: 250px;
    }
  }
}
</style>
~~~

第四步：在HomePage使用组件

~~~vue
<template>
  <LayoutTemplate>
    <div class="container">
      <HomeCategory />
      <HomeBanner />
    </div>
  </LayoutTemplate>
</template>

<script>
import LayoutTemplate from "@/views/LayoutTemplate.vue";
import HomeCategory from "@/views/home/components/HomeCategory.vue";
import HomeBanner from "@/views/home/components/HomeBanner.vue";
export default {
  components: {
    LayoutTemplate,
    HomeCategory,
    HomeBanner,
  },
  name: "HomePage",
};
</script>
~~~

### 16. 实现轮播图逻辑封装

- [ ] 实现点击轮播图左右按钮切换轮播图功能
- [ ] 实现点击导航原点轮播
- [ ] 实现轮播图的自动轮播功能

第一步：发起请求获取轮播图数据

~~~js
/**
 * 获取轮播图数据
 * @param {Number} distributionSite
 * @returns {Promise<{result: Array<Brand>}>}
 */
export function getBanners(distributionSite = 1) {
  return requestWithoutToken("/home/banner", "get", { distributionSite });
}
~~~

第二步：在父组件中获取数据

~~~vue
<template>
  <div class="home-banner">
    <XtxCarousel
      :autoPlay="true"
      :duration="3000"
      v-if="banners"
      :carsousel="banners"
    />
  </div>
</template>
<script>
import { getBanners } from "@/api/home";
import { ref } from "vue";

export default {
  name: "HomeBanner",
  setup() {
    const { banners, getData } = useBanners();
    getData();
    return { banners };
  },
};
function useBanners() {
  const banners = ref();
  const getData = () => {
    getBanners().then((res) => {
      banners.value = res.result;
    });
  };
  return { banners, getData };
}
</script>
~~~

第三步：渲染轮播图数据

~~~vue
<template>
<li
  class="carousel-item"
  :class="{ fade: index === currentIndex }"
  v-for="(item, index) in carsousel"
  :key="item.id"
>
  <RouterLink :to="item.hrefUrl">
    <img :src="item.imgUrl" alt="" />
  </RouterLink>
</li>
</template>
<script>
  export default {
      props: {
    carsousel: {
      type: Array,
    },
    autoPlay: {
      type: Boolean,
      default: false,
    },
    duration: {
      type: Number,
      default: 3000,
    },
  },
    setup(){
       const { banners, getData } = useBanners();
       getData();
       return { banners };
    }
  }
  function useBanners() {
  const banners = ref();
  const getData = () => {
    getBanners().then((res) => {
      banners.value = res.result;
    });
  };
  return { banners, getData };
}
</script>
~~~

第四步：实现点击左右按钮进行轮播

~~~js
//#region 轮播图左右切换事件
const toggle = (step) => {
  const nextStep = (currentIndex.value += step);
  if (nextStep < 0) {
    currentIndex.value = props.carsousel.length - 1;
  } else if (nextStep > props.carsousel.length - 1) {
    currentIndex.value = 0;
  } else {
    currentIndex.value = nextStep;
  }
  return nextStep;
};
//#endregion
~~~

~~~html
<a href="javascript:;" class="carousel-btn prev" @click="toggle(-1)">
  <i class="iconfont icon-angle-left"></i>
</a>
<a href="javascript:;" class="carousel-btn next" @click="toggle(1)">
  <i class="iconfont icon-angle-right"></i>
</a>
~~~

第五步：实现点击底部小点实现轮播

~~~html
<span
  v-for="(item, index) in carsousel.length"
  :key="item.id"
  @click="currentIndex = index"
  :class="{ active: currentIndex === index }"
></span>
~~~

第六步：自动切换轮播图

~~~js
    //#region 轮播图自动播放
    let timer = null;
    const startPlay = () => {
      if (props.autoPlay && props.carsousel.length > 1) {
        timer = setInterval(() => {
          toggle(1);
        }, props.duration);
      }
    };
    const stopPlay = () => {
      clearInterval(timer);
    };

    onMounted(startPlay);
    onUnmounted(stopPlay);
    //#endregion
~~~

~~~html
  <div class="xtx-carousel" @mouseenter="stopPlay" @mouseleave="startPlay"></div>
~~~

### 17. 封装面板属性

- [ ] 分析面板组件的组成以及实现思路
- [ ] 封装查看更多组件
- [ ] 封装面板组件

------

第一步：创建HomePanel组件

~~~vue
<template>
  <div class="home-panel">
    <div class="container">
      <div class="head">
        <h3>
          {{ title }}<small>{{ subTitle }}</small>
        </h3>
        <slot name="right"></slot>
      </div>
      <slot name="default"></slot>
    </div>
  </div>
</template>

<script>
export default {
  name: "HomePanel",
  props: {
    title: {
      type: String,
      default: "",
    },
    subTitle: {
      type: String,
      default: "",
    },
  },
};
</script>

<style scoped lang="less">
.home-panel {
  background-color: #fff;
  .head {
    padding: 40px 0;
    display: flex;
    align-items: flex-end;
    h3 {
      flex: 1;
      font-size: 32px;
      font-weight: normal;
      margin-left: 6px;
      height: 35px;
      line-height: 35px;
      small {
        font-size: 16px;
        color: #999;
        margin-left: 20px;
      }
    }
  }
}
</style>
~~~

第二步：封装`components/library/XtxMore.vue`小组件

~~~vue
<template>
  <RouterLink :to="path" class="xtx-more">
    <span>查看全部</span>
    <i class="iconfont icon-angle-right"></i>
  </RouterLink>
</template>

<script>
export default {
  name: "XtxMore",
  props: {
    path: {
      type: String,
      default: "/",
    },
  },
};
</script>

<style scoped lang="less">
.xtx-more {
  margin-bottom: 2px;
  span {
    font-size: 16px;
    vertical-align: middle;
    margin-right: 4px;
    color: #999;
  }
  i {
    font-size: 14px;
    vertical-align: middle;
    position: relative;
    top: 2px;
    color: #ccc;
  }
  &:hover {
    span,
    i {
      color: @xtxColor;
    }
  }
}
</style>
~~~

第三步：全局挂载

~~~js
import XtxMore from "@/components/library/XtxMore";

export default {
  install (app) {
    app.component(XtxMore.name, XtxMore);
  }
}
~~~


### 18. 实现鲜新好物

- [ ] 创建用于获取新鲜好物的 API 接口函数
- [ ] 创建新鲜好物组件并在首页组件中进行调用
- [ ] 在新鲜好物组件中获取数据
- [ ] 渲染新鲜好物数据到模板中

------

第一步：实现API接口

~~~js
/**
 * 获取新鲜好物数据
 * @param {Number} limit
 * @returns {Promise<{result: Array<Brand>}>}
 */
export function getNewGoods(limit = 4) {
  return requestWithoutToken("/home/new", "get", { limit });
}
~~~

第二步：创建页面 `views/home/components/HomeNew.vue`

~~~vue
<template>
  <HomePanel title="新鲜好物" subTitle="新鲜出炉 品质靠谱">
    <template v-slot:right>
      <XtxMore />
    </template>
    <template v-slot:default>
      <ul class="goods-list">
        <li>
          <RouterLink to="/">
            <img
              src="https://yanxuan-item.nosdn.127.net/7ef0f743fe590efc6c5eda075c632aa0.jpg"
              alt=""
            />
            <p class="name ellipsis">户外休闲防滑徒步鞋轻量速干G-GRIP大底</p>
            <p class="price">&yen;339.00</p>
          </RouterLink>
        </li>
      </ul>
    </template>
  </HomePanel>
</template>
<script>
import HomePanel from "@/views/home/components/HomePanel";
export default {
  name: "HomeNew",
  components: { HomePanel },
};
</script>
<style scoped lang="less">
.goods-list {
  display: flex;
  justify-content: space-between;
  height: 406px;
  li {
    width: 306px;
    height: 406px;
    background: #f0f9f4;
    .hoverShadow();
    img {
      width: 306px;
      height: 306px;
    }
    p {
      font-size: 22px;
      padding: 12px 30px 0 30px;
      text-align: center;
    }
    .price {
      color: @priceColor;
    }
  }
}
</style>
~~~

第三步：获取数据

~~~vue
<script>
import { getNewGoods } from "@/api/home";
import HomePanel from "@/views/home/components/HomePanel";
import { ref } from "vue";
export default {
  name: "HomeNew",
  components: { HomePanel },
  setup() {
    const { goods, getData } = useNewGoods();
    getData();
    return {
      goods,
    };
  },
};
function useNewGoods() {
  const goods = ref();
  const getData = () => {
    getNewGoods().then((res) => {
      goods.value = res.result;
    });
  };
  return { goods, getData };
}
</script>
~~~

第四步：渲染模板

~~~html
<li v-for="item in goods" :key="item.id">
  <RouterLink to="/">
    <img :src="item.picture" :alt="item.name" />
    <p class="name ellipsis">{{ item.name }}</p>
    <p class="price">&yen;{{ item.price }}</p>
  </RouterLink>
</li>
~~~

第五步：在 HomePage 使用

~~~vue
<template>
  <LayoutTemplate>
    <div class="container">
      <HomeCategory />
      <HomeBanner />
      <!-- 新鲜好物 -->
      <HomeNew />
    </div>
  </LayoutTemplate>
</template>

<script>
import HomeNew from "./components/HomeNew.vue";
import LayoutTemplate from "@/views/LayoutTemplate.vue";
import HomeCategory from "@/views/home/components/HomeCategory.vue";
import HomeBanner from "@/views/home/components/HomeBanner.vue";
export default {
  components: {
    LayoutTemplate,
    HomeCategory,
    HomeBanner,
    HomeNew,
  },
  name: "HomePage",
};
</script>

<style></style>

~~~

### 19. 实现人气推荐

- [ ] 创建用于获取人气推荐的 API 接口函数
- [ ] 创建人气推荐组件实现基础布局并在首页组件中进行调用
- [ ] 在人气推荐组件中获取人气推荐数据
- [ ] 将获取到的人气推荐数据渲染至模板

------

第一步：实现API接口

~~~js
/**
 * 获取人气推荐数据
 * @returns {Promise<{result: Array<Brand>}>}
 */
export function getHomeHot() {
  return requestWithoutToken("/home/hot", "get");
}
~~~

第二步：创建 HomeHot 页面

~~~vue
<template>
  <HomePanel title="人气推荐" sub-title="人气爆款 不容错过">
    <ul class="goods-list">
      <li>
        <RouterLink to="/">
          <img
            src="https://yjy-oss-files.oss-cn-zhangjiakou.aliyuncs.com/tuxian/popular_1.jpg"
            alt=""
          />
          <p class="name">特惠推荐</p>
          <p class="desc">它们最实惠</p>
        </RouterLink>
      </li>
    </ul>
  </HomePanel>
</template>

<script>
import HomePanel from "@/views/home/components/HomePanel";
export default {
  name: "HomeHot",
  components: { HomePanel },
};
</script>
<style scoped lang="less">
.goods-list {
  display: flex;
  justify-content: space-between;
  height: 426px;
  li {
    width: 306px;
    height: 406px;
    .hoverShadow();
    img {
      width: 306px;
      height: 306px;
    }
    p {
      font-size: 22px;
      padding-top: 12px;
      text-align: center;
    }
    .desc {
      color: #999;
      font-size: 18px;
    }
  }
}
</style>
~~~

第三步：获取数据

~~~vue
<script>
import { getHomeHot } from "@/api/home";
import HomePanel from "@/views/home/components/HomePanel";
import { ref } from "@vue/reactivity";
export default {
  name: "HomeHot",
  components: { HomePanel },
  setup() {
    const { homeHot, getData } = useHomeHot();
    getData();
    return {
      homeHot,
    };
  },
};
function useHomeHot() {
  const homeHot = ref();
  const getData = () => {
    getHomeHot().then((res) => {
      homeHot.value = res.result;
    });
  };
  return { homeHot, getData };
}
</script>
~~~

第四步：渲染模板

~~~html
<li v-for="item in homeHot" :key="item.id">
  <RouterLink to="/">
    <img :src="item.picture" :alt="item.alt" />
    <p class="name">{{ item.title }}</p>
    <p class="desc">{{ item.alt }}</p>
  </RouterLink>
</li>
~~~

第五步：在 HomePage 使用

~~~vue
<template>
  <LayoutTemplate>
    <div class="container">
      <HomeCategory />
      <HomeBanner />
      <!-- 新鲜好物 -->
      <HomeNew />
      <!-- 人气推荐 -->
      <HomeHot />
    </div>
  </LayoutTemplate>
</template>

<script>
import HomeHot from "./components/HomeHot.vue";
import HomeNew from "./components/HomeNew.vue";
import LayoutTemplate from "@/views/LayoutTemplate.vue";
import HomeCategory from "@/views/home/components/HomeCategory.vue";
import HomeBanner from "@/views/home/components/HomeBanner.vue";
export default {
  components: {
    LayoutTemplate,
    HomeCategory,
    HomeBanner,
    HomeNew,
    HomeHot,
  },
  name: "HomePage",
};
</script>

<style></style>
~~~

## 20. 实现数据懒加载

- [ ] 了解 `useIntersectionObserver` 方法的基本使用
- [ ] 封装数据懒加载通用逻辑
- [ ] 实现新鲜好物区块数据懒加载
- [ ] 实现热门推荐区块数据懒加载

------

数据懒加载指的是用户初始访问页面时可视区以外的数据暂时不加载，当用户将该区域内容滚动到可视区以内再进行加载，此技术可提高页面加载速度，提高用户体验。

第一步: 监控目标元素是否进入可视区

```html
<div ref="target"> Hello world</div>
```

```javascript
import { ref } from 'vue'
import { useIntersectionObserver } from '@vueuse/core'

export default {
  setup() {
    // target 目标监听元素
    const target = ref(null)
    // 调用方法监听元素是否进入可视区
    // 调用 stop 方法可停止元素的监听
    const { stop } = useIntersectionObserver(
      // 目标监听元素
      target,
      // isIntersecting 布尔类型 true 元素进入可视区 false 元素离开可视区
      // observerElement 被监听元素
      ([{ isIntersecting }], observerElement) => {}
    )
    return { target }
  }
}
```

第二步: 将数据懒加载逻辑封装起来, 方便复用。

`hooks/useLazyData.js`

```javascript
import { ref } from "vue";
import { useIntersectionObserver } from "@vueuse/core";

/**
 * 监听元素进入可视区, 进行数据加载
 * @param apiFunction 用于获取数据的 api 函数
 * @return {{result: ToRef<null>, target: ToRef<null>}}
 */
export default function useLazyData(apiFunction) {
  // 创建元素引用对象
  const target = ref(null);
  // 存储数据
  const result = ref(null);
  // 监听元素进入可视区
  const { stop } = useIntersectionObserver(target, ([{ isIntersecting }]) => {
    // 元素进入可视区
    if (isIntersecting) {
      // 停止监听
      stop();
      // 获取数据
      apiFunction().then((data) => (result.value = data.result));
    }
  });
  return { target, result };
}
```

第三步: 在新鲜好物组件中应用数据懒加载

`views/home/components/HomeNew.vue`

```javascript
import useLazyData from "@/hooks/useLazyData";
export default {
  name: "HomeNew",
  setup() {
    // 监听元素进入可视区时加载新鲜好物数据
    const { target, result } = useLazyData(getNewGoods);
    // 获取新鲜好物并存储新鲜好物
    return { newGoods: result, target };
  },
};
```

```vue
<HomePanel title="新鲜好物" subTitle="新鲜出炉 品质靠谱" ref="target"></HomePanel>
```

第四步: 在人气推荐组件中应用数据懒加载

`views/home/components/HomeHot.vue`

```javascript
import useLazyData from "@/hooks/useLazyData";
export default {
  name: "HomeHot",
  setup() {
    const { target, result } = useLazyData(getHotGoods);
    return { hotGoods: result, target };
  },
};
```

```vue
<HomePanel title="人气推荐" sub-title="人气爆款 不容错过" ref="target"></HomePanel>
```

## 21. 实现面板骨架效果

- [ ] 创建新鲜好物和人气推荐要使用的骨架布局组件
- [ ] 在新鲜好物组件中添加骨架屏效果
- [ ] 为骨架屏组件添加离场动画
- [ ] 在人气推荐组件中添加骨架屏效果

------

第一步: 创建骨架布局组件

`views/home/components/HomeSkeleton.vue`

```html
<template>
  <div class="home-skeleton">
    <div class="item" v-for="i in 4" :key="i" :style="{ backgroundColor: bg }">
      <XtxSkeleton
        bg="#e4e4e4"
        width="306px"
        height="306px"
        animated="scroll"
      />
      <XtxSkeleton bg="#e4e4e4" width="160px" height="24px" animated="scroll" />
      <XtxSkeleton bg="#e4e4e4" width="120px" height="24px" animated="scroll" />
    </div>
  </div>
</template>

<script>
export default {
  name: "HomeSkeleton",
  props: {
    bg: {
      type: String,
      default: "#fff",
    },
  },
};
</script>

<style scoped lang="less">
.home-skeleton {
  width: 1240px;
  height: 406px;
  display: flex;
  justify-content: space-between;
  .item {
    width: 306px;
    .xtx-skeleton ~ .xtx-skeleton {
      display: block;
      margin: 16px auto 0;
    }
  }
}
</style>
```

第二步: 在新鲜好物组件中添加骨架屏效果

`views/home/components/HomeNew.vue`

```vue
<ul class="goods-list" v-if="newGoods"></ul>
<HomeSkeleton v-else />
```

```javascript
import HomeSkeleton from "@/views/home/components/HomeSkeleton";

export default {
  components: { HomeSkeleton }
}
```

第三步: 为骨架屏的隐藏添加 Transition 动画

`assets/styles/common.less`

```less
.fade {
  &-leave {
    &-active {
      position: absolute;
      width: 100%;
      transition: opacity 0.5s 0.2s;
      z-index: 1;
    }
    &-to {
      opacity: 0;
    }
  }
}
// .fade-leave-active {}
// .fade-leave-to {}
```

```vue
<Transition name="fade">
  <ul class="goods-list" v-if="newGoods"></ul>
  <HomeSkeleton v-else />
</Transition>
```

第四步: 在人气推荐组件中添加骨架屏效果

`views/home/components/HomeHot.vue`

```html
<Transition name="fade">
  <ul class="goods-list" v-if="hotGoods"></ul>
  <HomeSkeleton v-else />
</Transition>
<script>
import HomeSkeleton from "@/views/home/components/HomeSkeleton";
export default {
  components: { HomeSkeleton }
}
</script>
```

## 22. 实现热门品牌

- [ ] 创建热门品牌组件, 实现基础布局
- [ ] 获取热门品牌数据并展示 (数据懒加载)
- [ ] 实现热门品牌左右滚动效果
- [ ] 实现热门品牌骨架屏效果
- [ ] 抽取将图片切换逻辑

------

第一步: 创建热门品牌组件, 实现基础布局

`views/home/components/HomeBrand.vue`

```html
<template>
  <HomePanel title="热门品牌" subTitle="国际经典 品质保证">
    <template v-slot:right>
      <a href="javascript:" class="iconfont icon-angle-left prev"></a>
      <a href="javascript:" class="iconfont icon-angle-right next"></a>
    </template>
    <template v-slot:default>
      <div class="box">
        <ul class="list">
          <li v-for="i in 10" :key="i">
            <RouterLink to="/">
              <img
                src="http://zhoushugang.gitee.io/erabbit-client-pc-static/uploads/brand_goods_1.jpg"
                alt=""
              />
            </RouterLink>
          </li>
        </ul>
      </div>
    </template>
  </HomePanel>
</template>

<script>
import HomePanel from "@/views/home/components/HomePanel";
export default {
  name: "HomeBrand",
  components: { HomePanel },
};
</script>

<style scoped lang="less">
.home-panel {
  background: #f5f5f5;
}
.iconfont {
  width: 20px;
  height: 20px;
  background: #ccc;
  color: #fff;
  display: inline-block;
  text-align: center;
  margin-left: 5px;
  background: @xtxColor;
  &::before {
    font-size: 12px;
    position: relative;
    top: -2px;
  }
  &.disabled {
    background: #ccc;
    cursor: not-allowed;
  }
}
.box {
  display: flex;
  width: 100%;
  height: 345px;
  overflow: hidden;
  padding-bottom: 40px;
  .list {
    width: 200%;
    display: flex;
    transition: all 1s;
    li {
      margin-right: 10px;
      width: 240px;
      &:nth-child(5n) {
        margin-right: 0;
      }
      img {
        width: 240px;
        height: 305px;
      }
    }
  }
}
</style>
```

在首页组件中调用热门品牌组件

`views/home/HomePage.vue`

```html
<template>
  <!-- 热门品牌 -->
  <HomeBrand />
</template>
<script>
import HomeBrand from "@/views/home/components/HomeBrand";
export default {
  components: { HomeBrand }
}
</script>
```

第二步: 获取热门品牌数据并展示

`views/home/components/HomeBrand.vue`

```javascript
import { getHotBrands } from "@/api/home";
import useLazyData from "@/hooks/useLazyData";

export default {
  setup() {
    const { target, result } = useLazyData(getHotBrands);
    return { target, result };
  },
};
```

```vue
<li v-for="item in result" :key="item.id">
  <RouterLink to="/">
    <img :src="item.picture" :alt="item.name" />
  </RouterLink>
</li>
```

第三步: 实现热门品牌左右滚动效果

`views/home/components/HomeBrand.vue`

```javascript
// src/views/home/components/home-brand.vue
export default {
  setup () {
    // 切换索引
    const currentIndex = ref(0);
    // 控制切换索引
    const toggle = (step) => {
      // 计算索引
      const nextIndex = currentIndex.value + step;
      // 控制索引返回
      if (nextIndex < 0 || nextIndex > 1) return;
      // 如果索引在正常范围就更改索引
      currentIndex.value = nextIndex;
    };
    return { toggle, currentIndex }
  }
}
```

```html
<a @click="toggle(-1)" :class="{ disabled: currentIndex === 0 }"></a>
<a @click="toggle(1)" :class="{disabled: currentIndex === 1}"></a>

<ul class="list" :style="{ transform: `translateX(${-currentIndex * 1240}px)` }"></ul>
```

第四步: 实现热门品牌骨架屏效果

`views/home/components/HomeBrand.vue`

```html
<transition name="fade">
    <ul v-if="result"></ul>
    <div v-else class="skeleton">
      <xtx-skeleton class="item" v-for="i in 5" :key="i" animated="scroll" bg="#e4e4e4" width="240px" height="305px" />
    </div>
</transition>
```

```less
.skeleton {
  width: 100%;
  display: flex;
  .item {
    margin-right: 10px;
    &:nth-child(5n) {
      margin-right: 0;
    }
  }
}
```

第五步: 抽取将图片切换逻辑

```javascript
function useToggle() {
  // 切换索引
  const currentIndex = ref(0);
  // 控制切换索引
  const toggle = (step) => {
    // 计算索引
    const nextIndex = currentIndex.value + step;
    // 控制索引返回
    if (nextIndex < 0 || nextIndex > 1) return;
    // 如果索引在正常范围就更改索引
    currentIndex.value = nextIndex;
  };
  return { currentIndex, toggle };
}
```

```javascript
setup() {
    return { hotBrands: result, target, ...useToggle() };
  },
```

## 23. 实现产品区块


- [ ] 将商品盒子封装成一个单独的可复用组件
- [ ] 创建产品区块组件实现基础布局
- [ ] 在首页组件中调用产品区块组件
- [ ] 创建用于获取产品区块数据的 API 接口函数
- [ ] 实现产品区块数据懒加载并将数据渲染至模板中
- [ ] 了解 `useIntersectionObserver` 方法中 `threshold` 的作用

------

第一步: 将商品盒子封装成一个单独的可复用组件

`views/home/components/HomeGoods.vue`

```html
<template>
  <div class="goods-item">
    <RouterLink to="/" class="image">
      <img
        src="http://zhoushugang.gitee.io/erabbit-client-pc-static/uploads/fresh_goods_1.jpg"
        alt=""
      />
    </RouterLink>
    <p class="name ellipsis-2">美威 智利原味三文鱼排 240g/袋 4片装</p>
    <p class="desc ellipsis">海鲜年货</p>
    <p class="price">&yen;108.00</p>
    <div class="extra">
      <RouterLink to="/">
        <span>找相似</span>
        <span>发现现多宝贝 &gt;</span>
      </RouterLink>
    </div>
  </div>
</template>

<script>
export default {
  name: "HomeGoods",
};
</script>

<style scoped lang="less">
.goods-item {
  width: 240px;
  height: 300px;
  padding: 10px 30px;
  position: relative;
  overflow: hidden;
  border: 1px solid transparent;
  transition: all 0.5s;
  .image {
    display: block;
    width: 160px;
    height: 160px;
    margin: 0 auto;
    img {
      width: 100%;
      height: 100%;
    }
  }
  p {
    margin-top: 6px;
    font-size: 16px;
    &.name {
      height: 44px;
    }
    &.desc {
      color: #666;
      height: 22px;
    }
    &.price {
      margin-top: 10px;
      font-size: 20px;
      color: @priceColor;
    }
  }
  .extra {
    position: absolute;
    left: 0;
    bottom: 0;
    height: 86px;
    width: 100%;
    background: @xtxColor;
    text-align: center;
    transform: translate3d(0, 100%, 0);
    transition: all 0.5s;
    span {
      display: block;
      color: #fff;
      width: 120px;
      margin: 0 auto;
      line-height: 30px;
      &:first-child {
        font-size: 18px;
        border-bottom: 1px solid #fff;
        line-height: 40px;
        margin-top: 5px;
      }
    }
  }
  &:hover {
    border-color: @xtxColor;
    .extra {
      transform: none;
    }
  }
}
</style>
```

第二步: 创建产品区块组件实现基础布局

`views/home/components/HomeProduct.vue`

```html
<template>
  <div class="home-product">
    <HomePanel title="生鲜" v-for="i in 4" :key="i">
      <template v-slot:right>
        <div class="sub">
          <RouterLink to="/">海鲜</RouterLink>
          <RouterLink to="/">水果</RouterLink>
          <RouterLink to="/">蔬菜</RouterLink>
          <RouterLink to="/">水产</RouterLink>
          <RouterLink to="/">禽肉</RouterLink>
        </div>
        <XtxMore />
      </template>
      <template v-slot:default>
        <div class="box">
          <RouterLink class="cover" to="/">
            <img
              src="http://zhoushugang.gitee.io/erabbit-client-pc-static/uploads/fresh_goods_cover.jpg"
              alt=""
            />
            <strong class="label">
              <span>生鲜馆</span>
              <span>全场3件7折</span>
            </strong>
          </RouterLink>
          <ul class="goods-list">
            <li v-for="i in 8" :key="i">
              <HomeGoods />
            </li>
          </ul>
        </div>
      </template>
    </HomePanel>
  </div>
</template>

<script>
import HomeGoods from "@/views/home/components/HomeGoods";
import HomePanel from "@/views/home/components/HomePanel";
import XtxMore from "@/components/library/XtxMore";
export default {
  name: "HomeProduct",
  components: { XtxMore, HomePanel, HomeGoods },
};
</script>

<style scoped lang="less">
.home-product {
  background: #fff;
  height: 2900px;
  .sub {
    margin-bottom: 2px;
    a {
      padding: 2px 12px;
      font-size: 16px;
      border-radius: 4px;
      &:hover {
        background: @xtxColor;
        color: #fff;
      }
      &:last-child {
        margin-right: 80px;
      }
    }
  }
  .box {
    display: flex;
    .cover {
      width: 240px;
      height: 610px;
      margin-right: 10px;
      position: relative;
      img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .label {
        width: 188px;
        height: 66px;
        display: flex;
        font-size: 18px;
        color: #fff;
        line-height: 66px;
        font-weight: normal;
        position: absolute;
        left: 0;
        top: 50%;
        transform: translate3d(0, -50%, 0);
        span {
          text-align: center;
          &:first-child {
            width: 76px;
            background: rgba(0, 0, 0, 0.9);
          }
          &:last-child {
            flex: 1;
            background: rgba(0, 0, 0, 0.7);
          }
        }
      }
    }
    .goods-list {
      width: 990px;
      display: flex;
      flex-wrap: wrap;
      li {
        width: 240px;
        height: 300px;
        margin-right: 10px;
        margin-bottom: 10px;
        &:nth-last-child(-n + 4) {
          margin-bottom: 0;
        }
        &:nth-child(4n) {
          margin-right: 0;
        }
      }
    }
  }
}
</style>
```

第三步: 在首页组件中调用产品区块组件

`views/home/HomePage.vue`

```html
<template>
  <!-- 产品区块 -->
  <HomeProduct />
</template>
<script>
import HomeProduct from "@/views/home/components/HomeProduct";
export default {
  components: {
    HomeProduct
  }
}
</script>
```

第四步: 在 `api/home.js` 中导出用于获取产品区块数据的 API 函数

`api/home.js`

```javascript
/**
 * @typedef {Object} Product  产品区块数据
 * @property {string} id - 分类id
 * @property {string} name - 分类名称
 * @property {string} picture - 分类封面图片
 * @property {string} saleInfo - 售卖信息
 * @property {Array<RecommendGoods>} goods - 产品信息
 * @property {Array<SubCategory>} children - 二级分类信息
 */

/**
 * @typedef {Object} SubCategory - 二级分类
 * @property {string} id - 数据id
 * @property {string} name - 分类名称
 */

/**
 * 获取产品区块数据
 * @return {Promise<{result: Array<Product>}>}
 */
export function getProducts() {
  return request("/home/goods", "get");
}
```

第五步: 实现产品区块数据懒加载并将数据渲染至模板中

`views/home/components/HomeProduct.vue`

```html
<template>
  <div class="home-product" ref="target">
    <HomePanel :title="item.name" v-for="item in goods" :key="item.id">
      <template v-slot:right>
        <div class="sub">
          <RouterLink
            :to="`/category/sub/${sub.id}`"
            v-for="sub in item.children"
            :key="sub.id"
            >{{ sub.name }}</RouterLink
          >
        </div>
        <XtxMore :path="`/category/${item.id}`" />
      </template>
      <div class="box">
        <RouterLink class="cover" to="/">
          <img :src="item.picture" alt="" />
          <strong class="label">
            <span>{{ item.name }}馆</span>
            <span>{{ item.saleInfo }}</span>
          </strong>
        </RouterLink>
        <ul class="goods-list" v-if="item.goods">
          <li v-for="goods in item.goods" :key="goods.id">
            <HomeGoods :goods="goods" />
          </li>
        </ul>
      </div>
    </HomePanel>
  </div>
</template>

<script>
import useLazyData from "@/hooks/useLazyData";
import { getProducts } from "@/api/home";
export default {
  setup() {
    const { target, result } = useLazyData(getProducts);
    return { goods: result, target };
  },
};
</script>
```

渲染商品数据

`views/home/components/HomeGoods.vue`

```vue
<template>
  <div class="goods-item">
    <RouterLink :to="`/product/${goods.id}`" class="image">
      <img :src="goods.picture" alt="" />
    </RouterLink>
    <p class="name ellipsis-2">{{ goods.name }}</p>
    <p class="desc ellipsis">{{ goods.desc }}</p>
    <p class="price">&yen;{{ goods.price }}</p>
    <div class="extra">
      <RouterLink to="/">
        <span>找相似</span>
        <span>发现现多宝贝 &gt;</span>
      </RouterLink>
    </div>
  </div>
</template>

<script>
export default {
  name: "HomeGoods",
  props: {
    goods: {
      type: Object,
    },
  },
};
</script>
```

第五步: 设置元素进入可视区的临界值，让元素只要进入可视区就进行数据懒加载

如果被监听元素的大小小于可视区大小时, 只要元素一进入可视区就可以被监听到. 

如果被监听元素的大小大于可视区的大小, 元素大小和可视区大小之间会有一个相交比例, 只有达到这个相交比例时, 元素才算真正进入可视区. 比如我们可以设置当元素进入可视区的 20% 时, 元素才算进入可视区

可以通过 `threshold` 配置项更改这个默认行为, 0 表示只要元素进入可视区, 就被监听到

```javascript
// src/hooks/useLazyData.js
useIntersectionObserver(target, () => {}, { threshold: 0 })
```

## 24. 实现图片懒加载


- [ ] 学习 `IntersectionObserver` 类的使用
- [ ] 创建一个用于图片懒加载的指令
- [ ] 将指令注册到应用全局范围内
- [ ] 在产品区块应用图片懒加载指令

```vue
<img v-lazy="imgUrl"/>
```

第一步: 预先学习一个前置 API, `IntersectionObserver`, 用于监听 DOM 元素进入离开可视区。

`/test/IntersectionObserver.html`

```javascript
// 创建观察对象
const observer = new IntersectionObserver(callback)
// callback: 被观察 dom 对象进入可视区离开可视区都会触发

// 实例提供两个方法
// observe(dom) 观察哪个dom
// unobserve(dom) 停止观察那个dom
```

```javascript
// 获取要监听的元素
const box = document.getElementById('box')
// 创建监听对象
const observer = new IntersectionObserver(([{isIntersecting}]) => {
  // 判断元素是否进入可视区
  if (isIntersecting) {
    // 停止监听
    observer.unobserve(box)
    console.log('进入可视区')
  }
})
// 指定要监听的元素
observer.observe(box)
```

第二步: 创建一个用于图片懒加载的指令

`components/directive/lazy.js`

```javascript
// 导入默认产品图片
import defaultImage from "@/assets/images/default.png";

const lazy = {
  // 指令所在元素挂载完成后
  mounted(el, binding) {
    // 创建元素监听对象
    const observer = new IntersectionObserver(([{ isIntersecting }]) => {
      // 判断元素是否进入可视区
      if (isIntersecting) {
        // 停止监听元素
        observer.unobserve(el);
        // 动态加载图片
        el.src = binding.value;
        // 当图片加载出错时
        el.onerror = () => {
          // 显示默认产品图片
          el.src = defaultImage;
        };
      }
    });
    // 指定要监听的元素
    observer.observe(el);
  },
};

export default lazy;
```

第三步: 将指令注册到应用全局范围内

`components/library/index.js`

```javascript
import lazy from "@/components/directive/lazy";

const UI = {
  install(app) {
    app.directive("lazy", lazy);
  },
};
```

第三步: 在产品区块应用图片懒加载指令

`views/home/components/HomeProduct.vue`

`views/home/components/HomeGoods.vue`

```html
<img v-lazy="item.picture"/>
<img v-lazy="goods.picture"/>
```

## 25. 实现最新专题


- [ ] 创建最新专题组件, 实现基础布局
- [ ] 在首页组件中应用最新专题组件
- [ ] 创建用于获取最新专题数据的 API 函数
- [ ] 获取最新专题数据并渲染至模板中

------

第一步: 创建最新专题组件实现基础布局

`views/home/components/HomeSpecial`

```html
<template>
  <HomePanel title="最新专题">
    <template v-slot:right>
      <XtxMore />
    </template>
    <template v-slot:default>
      <div class="special-list">
        <div class="special-item" v-for="i in 3" :key="i">
          <RouterLink to="/">
            <img
              src="http://zhoushugang.gitee.io/erabbit-client-pc-static/uploads/topic_goods_1.jpg"
              alt
            />
            <div class="meta">
              <p class="title">
                <span class="top ellipsis">看到撒娇的撒娇的凯撒就</span>
                <span class="sub ellipsis">倒萨倒萨倒萨</span>
              </p>
              <span class="price">&yen;19.99起</span>
            </div>
          </RouterLink>
          <div class="foot">
            <span class="like"><i class="iconfont icon-hart1"></i>100</span>
            <span class="view"><i class="iconfont icon-see"></i>100</span>
            <span class="reply"><i class="iconfont icon-message"></i>100</span>
          </div>
        </div>
      </div>
    </template>
  </HomePanel>
</template>

<script>
import HomePanel from "@/views/home/components/HomePanel";
export default {
  name: "HomeSpecial",
  components: { HomePanel },
};
</script>

<style scoped lang="less">
.home-panel {
  background: #f5f5f5;
}
.special-list {
  height: 380px;
  padding-bottom: 20px;
  display: flex;
  justify-content: space-between;
  .special-item {
    width: 404px;
    background: #fff;
    .hoverShadow();
    a {
      display: block;
      width: 100%;
      height: 288px;
      position: relative;
      img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .meta {
        background-image: linear-gradient(
          to top,
          rgba(0, 0, 0, 0.8),
          transparent 50%
        );
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 288px;
        .title {
          position: absolute;
          bottom: 0;
          left: 0;
          padding-left: 16px;
          width: 70%;
          height: 70px;
          .top {
            color: #fff;
            font-size: 22px;
            display: block;
          }
          .sub {
            display: block;
            font-size: 19px;
            color: #999;
          }
        }
        .price {
          position: absolute;
          bottom: 25px;
          right: 16px;
          line-height: 1;
          padding: 4px 8px 4px 7px;
          color: @priceColor;
          font-size: 17px;
          background-color: #fff;
          border-radius: 2px;
        }
      }
    }
    .foot {
      height: 72px;
      line-height: 72px;
      padding: 0 20px;
      font-size: 16px;

      i {
        display: inline-block;
        width: 15px;
        height: 14px;
        margin-right: 5px;
        color: #999;
      }
      .like,
      .view {
        float: left;
        margin-right: 25px;
        vertical-align: middle;
      }
      .reply {
        float: right;
        vertical-align: middle;
      }
    }
  }
}
</style>
```

第二步: 在首页组件中应用最新专题组件

```html
<template>
  <!-- 最新专题 -->
  <HomeSpecial />
</template>
<script>
import HomeSpecial from "@/views/home/components/HomeSpecial";
export default {
  name: 'Home',
  components: { HomeSpecial }
}
</script>
```

第三步: 在 `src/api/home.js` 中导出用于获取最新专题数据的 API 函数

`src/api/home.js`

```javascript
/**
 * @typedef {object} Special - 专题
 * @property {string} id - 数据ID
 * @property {string} title - 标题
 * @property {summary} summary - 副标题
 * @property {number} lowestPrice - 最低价格
 * @property {string} cover - 专题封面
 * @property {string} detailsUrl - 详情链接
 * @property {number} collectNum - 收藏数
 * @property {number} viewNum - 浏览数
 * @property {number} replyNum - 评论数量
 */

/**
 * 获取最新专题
 * @param {number} limit 限制请求数据的数量
 * @return {Promise<{result: Array<Special>}>}
 */
export function getSpecial(limit) {
  return request("/home/special", "get", { limit });
}
```

第四步: 在最新专题组件中获取数据并渲染

`views/home/components/HomeSpecial.vue`

```html
<template>
  <HomePanel title="最新专题" ref="target">
    <template v-slot:default>
      <div class="special-list">
        <div class="special-item" v-for="item in specials" :key="item.id">
          <RouterLink to="/">
            <img :src="item.cover" alt="" />
            <div class="meta">
              <p class="title">
                <span class="top ellipsis">{{ item.title }}</span>
                <span class="sub ellipsis">{{ item.summary }}</span>
              </p>
              <span class="price">&yen;{{ item.lowestPrice }}起</span>
            </div>
          </RouterLink>
          <div class="foot">
            <span class="like"
              ><i class="iconfont icon-hart1"></i>{{ item.collectNum }}</span
            >
            <span class="view"
              ><i class="iconfont icon-see"></i>{{ item.viewNum }}</span
            >
            <span class="reply"
              ><i class="iconfont icon-message"></i>{{ item.replyNum }}</span
            >
          </div>
        </div>
      </div>
    </template>
  </HomePanel>
</template>

<script>
import useLazyData from "@/hooks/useLazyData";
import { getSpecial } from "@/api/home";
export default {
  name: "HomeSpecial",
  setup() {
    const { target, result } = useLazyData(getSpecial);
    return { target, specials: result };
  },
};
</script>
```
